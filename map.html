<!doctype html>
    <title>AI Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 2rem auto;
        max-width: 700px;
        padding: 1rem;
        background: linear-gradient(135deg, #eef2f7, #dce3ed);
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      h1 {
        font-size: 2rem;
        text-align: center;
        color: #003366;
        margin-bottom: 0.5rem;
      }

      p {
        font-size: 0.9rem;
        text-align: center;
        color: #444;
        margin-bottom: 1.5rem;
      }

      textarea {
        width: 100%;
        height: 90px;
        padding: 0.5rem;
        font-size: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
        resize: none;
      }

      button {
        margin-top: 1rem;
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        font-weight: bold;
        background: #0059b3;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      button:hover {
        background: #004494;
      }

      #output {
        margin-top: 1.5rem;
        font-family: monospace;
        background: #ffffff;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.05);
        color: #222;
        font-size: 10px;
        height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  
  <body>
    <h1>WivX 0.3</h1>
    <p>This chat uses WebGPU to run GPT-2 in-browser. It remembers your past messages during this session.</p>

    <textarea id="inputText" placeholder="Type a message..."></textarea><br />
    <button id="generateBtn">Send</button>

    <div id="output">Loading model...</div>

    <script type="module">
      import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.10.0';

      const output = document.getElementById("output");
      const inputField = document.getElementById("inputText");
      const generateBtn = document.getElementById("generateBtn");

      let chatHistory = "This is a conversation between You and WivX AI assistant.\n";
      output.innerText = "Loading WivX 0.3...";
      const generator = await pipeline("text-generation", "Xenova/distilgpt2", { quantized: true });
      output.innerText = "Model ready. Type a message to start chatting.";

      generateBtn.addEventListener("click", async () => {
        const userInput = inputField.value.trim();
        if (!userInput) return;

        chatHistory += `User: ${userInput}\n\nAI:`;
        output.innerText = chatHistory + "\nWivX is typing...";

        try {
          const result = await generator(chatHistory, {
            max_new_tokens: 120,
            temperature: 0.65,         
            top_k: 40,                
            repetition_penalty: 1.25,
            stop: ["User:"]
          });

          const rawResponse = result[0].generated_text.replace(chatHistory, '').split("User:")[0].trim();
          const cleanResponse = rawResponse.replace(/\s+/g, ' ').trim();

          let fullDisplay = chatHistory;
          output.innerText = fullDisplay;

          for (let i = 0; i < cleanResponse.length; i++) {
            fullDisplay += cleanResponse[i];
            output.innerText = fullDisplay + "";
            output.scrollTop = output.scrollHeight;
            await new Promise(res => setTimeout(res, 20));
          }

          chatHistory += ` ${cleanResponse}\n`;
          output.innerText = chatHistory+`\n`;
          output.scrollTop = output.scrollHeight;
          inputField.value = "";

        } catch (err) {
          output.innerText = "Error: " + err.message;
        }
      });
    </script>
  </body>
</html>
